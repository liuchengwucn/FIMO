{
    "problem_name": "fimo_2021_number_theory_p8_2",
    "informal_statement": "A function $f: \\mathbb{Z} \\rightarrow \\mathbb{Z}$ is chosen so that $a-b \\mid f(a)-f(b)$ for all $a, b \\in \\mathbb{Z}$ with $a \\neq b$. Let $S_{0}=\\mathbb{Z}$, and for each positive integer $m$, let $S_{m}$ denote the image of $f$ on the set $S_{m-1}$. It is given that, for each nonnegative integer $m$, there are exactly $\\left\\lceil n / 2^{m}\\right\\rceil$ distinct residues modulo $n$ in the set $S_{m}$. Find all possible values of $n$.\n\nThe final answers are all powers of primes.",
    "informal_proof": "Observe that $f$ can be regarded as a function $\\mathbb{Z}_{\\ell} \\rightarrow \\mathbb{Z}_{\\ell}$ for any positive integer $\\ell$. We use notations $f^{m}$ and $f_{m, \\ell}$ as in the above solution. Part 1. There exists a function $f: \\mathbb{Z}_{p^{k}} \\rightarrow \\mathbb{Z}_{p^{k}}$ satisfying the desired properties.\n\nFor $x \\in \\mathbb{Z}_{p^{k}}$, let $\\operatorname{rev}(x)$ denote the reversal of the base- $p$ digits of $x$ (we write every $x \\in \\mathbb{Z}_{p^{k}}$ with exactly $k$ digits, adding zeroes at the beginning if necessary). Choose\n\n$$\nf(x)=\\operatorname{rev}\\left(\\left\\lfloor\\frac{\\operatorname{rev}(x)}{2}\\right\\rfloor\\right)\n$$\n\nwhere, for dividing by $2, \\operatorname{rev}(x)$ is interpreted as an integer in the range $\\left[0, p^{k}\\right)$. It is easy to see that $f_{m+1, k}=\\left\\lceil f_{m, k} / 2\\right\\rceil$\n\nWe claim that if $a, b \\in \\mathbb{Z}_{p^{k}}$ so that $p^{m} \\mid a-b$, then $p^{m} \\mid f(a)-f(b)$. Let $x=\\operatorname{rev}(a), y=\\operatorname{rev}(b)$. The first $m$ digits of $x$ and $y$ are the same, i.e $\\left\\lfloor x / p^{m-k}\\right\\rfloor=\\left\\lfloor y / p^{m-k}\\right\\rfloor$. For every positive integers $c, d$ and $z$ we have $\\lfloor\\lfloor z / c\\rfloor / d\\rfloor=\\lfloor z /(c d)\\rfloor=\\lfloor[z / d\\rfloor / c\\rfloor$, so\n\n$$\n\\left\\lfloor\\lfloor x / 2\\rfloor / p^{m-k}\\right\\rfloor=\\left\\lfloor\\left\\lfloor x / p^{m-k}\\right\\rfloor / 2\\right\\rfloor=\\left\\lfloor\\left\\lfloor y / p^{m-k}\\right\\rfloor / 2\\right\\rfloor=\\left\\lfloor\\lfloor y / 2\\rfloor / p^{m-k}\\right\\rfloor .\n$$\n\nThus, the first $m$ digits of $\\lfloor x / 2\\rfloor$ and $\\lfloor y / 2\\rfloor$ are the same. So the last $m$ digits of $f(a)$ and $f(b)$ are the same, i.e. $p^{m} \\mid f(a)-f(b)$.\n\nPart 2. Lifting the function $f: \\mathbb{Z}_{p^{k}} \\rightarrow \\mathbb{Z}_{p^{k}}$ to a function on all of $\\mathbb{Z}$.\n\nWe show that, for any function $f: \\mathbb{Z}_{p^{k}} \\rightarrow \\mathbb{Z}_{p^{k}}$ for which $\\operatorname{gcd}\\left(p^{k}, a-b\\right) \\mid f(a)-f(b)$, there is a corresponding function $g: \\mathbb{Z} \\rightarrow \\mathbb{Z}$ for which $a-b \\mid g(a)-g(b)$ for all distinct integers $a, b$ and $g(x) \\equiv f(x)\\left(\\bmod p^{k}\\right)$ for all $x \\in \\mathbb{Z}$, whence the proof will be completed. We will construct the values of such a function inductively; assume that we have constructed it for some interval $[a, b)$ and wish to define $g(b)$. (We will define $g(a-1)$ similarly.)\n\nFor every prime $q \\leqslant|a-b|$, we choose the maximal $\\alpha_{q}$ for which there exists $c_{q} \\in[a, b)$, such that $b-c_{q} \\vdots q^{\\alpha_{q}}$, and choose one such $c_{q}$.\n\nWe apply Chinese remainder theorem to find $g(b)$ satisfying the following conditions:\n\n$$\n\\begin{gathered}\ng(b) \\equiv g\\left(c_{q}\\right) \\quad\\left(\\bmod q^{\\alpha_{q}}\\right) \\quad \\text { for } q \\neq p, \\quad \\text { and } \\\\\ng(b) \\equiv g\\left(c_{p}\\right) \\quad\\left(\\bmod q^{\\alpha_{p}}\\right) \\quad \\text { if } \\quad \\alpha_{p} \\geqslant k, \\quad g(b) \\equiv f(b) \\quad\\left(\\bmod p^{k}\\right) \\quad \\text { if } \\quad \\alpha_{p}<k\n\\end{gathered}\n$$\n\nIt is not hard to verify that $b-c \\mid g(b)-g(c)$ for every $c \\in[a, b)$ and $g(b) \\equiv f(b)\\left(\\bmod p^{k}\\right)$.\n\nPart 3. The required function does not exist if $n$ has at least two different prime divisors.\n\nLet $n=p^{k}$, where $p \\geqslant 3$ is prime and $k \\geqslant 2$. For $r \\in \\mathbb{Z}_{p}$ let $S_{r}$ denote the subset of $\\mathbb{Z}_{p^{k}}$ consisting of numbers congruent to $r$ modulo $p$. We denote the cardinality of a set $S$ by $|S|$. Claim. For any residue $r$ modulo $p$, either $\\left|P\\left(S_{r}\\right)\\right|=p^{k-1}$ or $\\left|P\\left(S_{r}\\right)\\right| \\leqslant p^{k-2}$.\n\nProof. Recall that $P(r+h)=P(r)+h P^{\\prime}(r)+h^{2} Q(r, h)$, where $Q$ is an integer polynomial.\n\nIf $p \\mid P^{\\prime}(r)$, then $P(r+p s) \\equiv P(r)\\left(\\bmod p^{2}\\right)$, hence all elements of $P\\left(S_{r}\\right)$ are congruent modulo $p^{2}$. So in this case $\\left|P\\left(S_{r}\\right)\\right| \\leqslant p^{k-2}$.\n\nNow we show that $p \\nmid P^{\\prime}(r)$ implies $\\left|P\\left(S_{r}\\right)\\right|=p^{k-1}$ for all $k$.\n\nSuppose the contrary: $\\left|P\\left(S_{r}\\right)\\right|<p^{k-1}$ for some $k>1$. Let us choose the smallest $k$ for which this is so. To each residue in $P\\left(S_{r}\\right)$ we assign its residue modulo $p^{k-1}$; denote the resulting set by $\\bar{P}(S, r)$. We have $|\\bar{P}(S, r)|=p^{k-2}$ by virtue of minimality of $k$. Then $\\left|P\\left(S_{r}\\right)\\right|<p^{k-1}=p \\cdot|\\bar{P}(S, r)|$, that is, there is $u=P(x) \\in P\\left(S_{r}\\right)(x \\equiv r(\\bmod p))$ and $t \\not \\equiv 0$ $(\\bmod p)$ such that $u+p^{k-1} t \\notin P\\left(S_{r}\\right)$.\n\nNote that $P\\left(x+p^{k-1} s\\right) \\equiv u+p^{k-1} s P^{\\prime}(x)\\left(\\bmod p^{k}\\right)$. Since $P\\left(x+p^{k-1} s\\right) \\not \\equiv u+p^{k-1} t$ $\\left(\\bmod p^{k}\\right)$, the congruence $p^{k-1} s P^{\\prime}(x) \\equiv p^{k-1} t\\left(\\bmod p^{k}\\right)$ has no solutions. So the congruence $s P^{\\prime}(x) \\equiv t(\\bmod p)$ has no solutions, which contradicts $p \\nmid P^{\\prime}(r)$. Since the image of $P^{m}$ consists of one element for sufficiently large $m$, we can take the smallest $m$ such that $\\left|P^{m-1}\\left(S_{r}\\right)\\right|=p^{k-1}$ for some $r \\in \\mathbb{Z}_{p}$, but $\\left|P^{m}\\left(S_{q}\\right)\\right| \\leqslant p^{k-2}$ for all $q \\in \\mathbb{Z}_{p}$.\n\nFrom now on, we fix $m$ and $r$.\n\nSince the image of $P^{m-1}\\left(\\mathbb{Z}_{p^{k}}\\right) \\backslash P^{m-1}\\left(S_{r}\\right)$ under $P$ contains $P^{m}\\left(\\mathbb{Z}_{p^{k}}\\right) \\backslash P^{m}\\left(S_{r}\\right)$, we have\n\n$$\na:=\\left|P^{m}\\left(\\mathbb{Z}_{p^{k}}\\right) \\backslash P^{m}\\left(S_{r}\\right)\\right| \\leqslant\\left|P^{m-1}\\left(\\mathbb{Z}_{p^{k}}\\right) \\backslash P^{m-1}\\left(S_{r}\\right)\\right|\n$$\n\nthus\n\n$$\na+p^{k-1} \\leqslant f_{m-1, p^{k}} \\leqslant 2 f_{m, p^{k}} \\leqslant 2 p^{k-2}+2 a\n$$\n\nso\n\n$$\n(p-2) p^{k-2} \\leqslant a\n$$\n\nSince $f_{i, p}=1$ for sufficiently large $i$, there is exactly one $t \\in \\mathbb{Z}_{p}$ such that $P(t) \\equiv t(\\bmod p)$. Moreover, as $i$ increases, the cardinality of the set $\\left\\{s \\in \\mathbb{Z}_{p} \\mid P^{i}(s) \\equiv t(\\bmod p)\\right\\}$ increases (strictly), until it reaches the value $p$. So either\n\n$$\n\\left|\\left\\{s \\in \\mathbb{Z}_{p} \\mid P^{m-1}(s) \\equiv t \\quad(\\bmod p)\\right\\}\\right|=p \\quad \\text { or } \\quad\\left|\\left\\{s \\in \\mathbb{Z}_{p} \\mid P^{m-1}(s) \\equiv t \\quad(\\bmod p)\\right\\}\\right| \\geqslant m .\n$$\n\nTherefore, either $f_{m-1, p}=1$ or there exists a subset $X \\subset \\mathbb{Z}_{p}$ of cardinality at least $m$ such that $P^{m-1}(x) \\equiv t(\\bmod p)$ for all $x \\in X$.\n\nIn the first case $\\left|P^{m-1}\\left(\\mathbb{Z}_{p^{k}}\\right)\\right| \\leqslant p^{k-1}=\\left|P^{m-1}\\left(S_{r}\\right)\\right|$, so $a=0$, a contradiction.\n\nIn the second case let $Y$ be the set of all elements of $\\mathbb{Z}_{p^{k}}$ congruent to some element of $X$ modulo $p$. Let $Z=\\mathbb{Z}_{p^{k}} \\backslash Y$. Then $P^{m-1}(Y) \\subset S_{t}, P\\left(S_{t}\\right) \\subsetneq S_{t}$, and $Z=\\bigcup_{i \\in \\mathbb{Z}_{p} \\backslash X} S_{i}$, so\n\n$$\n\\left|P^{m}(Y)\\right| \\leqslant\\left|P\\left(S_{t}\\right)\\right| \\leqslant p^{k-2} \\text { and }\\left|P^{m}(Z)\\right| \\leqslant\\left|\\mathbb{Z}_{p} \\backslash X\\right| \\cdot p^{k-2} \\leqslant(p-m) p^{k-2} .\n$$\n\nHence,\n\n$$\n(p-2) p^{k-2} \\leqslant a<\\left|P^{m}\\left(\\mathbb{Z}_{p^{k}}\\right)\\right| \\leqslant\\left|P^{m}(Y)\\right|+\\left|P^{m}(Z)\\right| \\leqslant(p-m+1) p^{k-2}\n$$\n\nand $m<3$. Then $\\left|P^{2}\\left(S_{q}\\right)\\right| \\leqslant p^{k-2}$ for all $q \\in \\mathbb{Z}_{p}$, so\n\n$$\np^{k} / 4 \\leqslant\\left|P^{2}\\left(\\mathbb{Z}_{p^{k}}\\right)\\right| \\leqslant p^{k-1}\n$$\n\nwhich is impossible for $p \\geqslant 5$. It remains to consider the case $p=3$.\n\nAs before, let $t$ be the only residue modulo 3 such that $P(t) \\equiv t(\\bmod 3)$.\n\nIf $3 \\nmid P^{\\prime}(t)$, then $P\\left(S_{t}\\right)=S_{t}$ by the proof of the Claim above, which is impossible.\n\nSo $3 \\mid P^{\\prime}(t)$. By substituting $h=3^{i} s$ into the formula $P(t+h)=P(t)+h P^{\\prime}(t)+h^{2} Q(t, h)$, we obtain $P\\left(t+3^{i} s\\right) \\equiv P(t)\\left(\\bmod 3^{i+1}\\right)$. Using induction on $i$ we see that all elements of $P^{i}\\left(S_{t}\\right)$ are congruent modulo $3^{i+1}$. Thus, $\\left|P^{k-1}\\left(S_{t}\\right)\\right|=1$.\n\nNote that $f_{1,3} \\leqslant 2$ and $f_{2,3} \\leqslant 1$, so $P^{2}\\left(\\mathbb{Z}_{3^{k}}\\right) \\subset S_{t}$. Therefore, $\\left|P^{k+1}\\left(\\mathbb{Z}_{3^{k}}\\right)\\right| \\leqslant\\left|P^{k-1}\\left(S_{t}\\right)\\right|=1$. It follows that $3^{k} \\leqslant 2^{k+1}$, which is impossible for $k \\geqslant 2$."
}